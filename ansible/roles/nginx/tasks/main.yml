---

- name: Allow http ports
  ufw:
      insert: 1 # To make sure it always goes before denied
      rule: allow
      port: "{{ item }}"
      proto: tcp
  with_items:
      - 80
      - 443
      - 9002
      - 9001
  tags:
      - nginx
      - firewall

- name: Add mainline nginx ppa
  apt_repository:
      repo: 'ppa:nginx/development'
  tags:
      - nginx


- name: Add nginx packages
  apt:
      name: nginx
      state: latest
  tags:
      - nginx

- name: Add htpasswd
  apt: name=apache2-utils
  tags:
      - nginx

- name: Install passlib
  apt: name=python-passlib
  tags:
      - nginx

- name: Add user and password
  htpasswd:
      path: /etc/nginx/passwdfile
      name: "{{ proxy_user }}"
      password: "{{ proxy_pass }}"
      owner: root
      group: www-data
      mode: 0660
  notify:
      - Restart nginx
  tags:
      - nginx

- name: Add certbot
  get_url:
      url: https://dl.eff.org/certbot-auto
      dest: /root/certbot-auto
      mode: 0500
  tags:
      - rotate_cert
      - nginx
  notify:
      - Stop nginx
      - Rotate cert
      - Start nginx

- name: Add nginx config
  template:
      src: templates/nginx.conf
      dest: /etc/nginx/nginx.conf
      mode: 0440
  notify:
      - Reload nginx
  tags:
      - nginx
      - nginx-config


- name: Add nginx config dirs
  file:
      dest: "/etc/nginx/conf.d/{{item}}"
      state: directory
  with_items:
      - http
      - tcp
  tags:
      - nginx
      - nginx-config

